# Стратегия миграции

### Выбранная стратегия: Parallel run

| Критерий                       | Обоснование                                                                          |
| ------------------------------ | ------------------------------------------------------------------------------------ |
| Минимизация простоя            | Система работает 24/7 — нельзя останавливать приём пациентов                         |
| Возможность тестирования в бою | Новая система тестируется параллельно с текущей — снижает риски                      |
| Валидация данных               | Можно сравнивать данные в старой и новой системе (diff-анализ)                       |
| Гибкость отката                | Если новая система падает — продолжаем работать со старой                            |
| Поддержка бизнес-процессов     | Администраторы и врачи учатся на "дубле", не рискуя ошибиться с реальными пациентами |

> **Почему не другие?**  
> - **High-level design** — требует полной остановки, недопустимо.  
> - **Branch by abstraction** — слишком медленный для критичных мер (бэкапы, шифрование).

---

# Cutover-план

| Этап                           | Описание действия                                                | Ключевые задачи                                                                                                                                                  | Ответственные                | Время/Сроки | Риски и меры по снижению                                                                          |
| ------------------------------ | ---------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- | ----------- | ------------------------------------------------------------------------------------------------- |
| 1. Подготовка окружения        | Развернуть "теньовую" копию системы для параллельного запуска    | - Настроить дубль PostgreSQL, MinIO, Keycloak<br>- Настроить feature toggle для включения параллельной записи<br>- Подготовить скрипты синхронизации и валидации | DevOps, Архитектор           | Месяц 0–1   | Риск: Рассинхрон данных<br>Мера: Автоматический diff-контроль каждые 15 мин                       |
| 2. Двойная запись (dual-write) | Все новые данные пишутся в обе системы: старую и новую           | - Настроить BFF: дублирование запросов<br>- Включить логирование в обеих системах<br>- Обеспечить идемпотентность операций                                       | Бэкенд-разработчик           | Месяц 1–2   | Риск: Ошибки дублирования<br>Мера: Валидация по ключам (patient_id, appointment_id) + alerting    |
| 3. Параллельная работа         | Персонал работает в старой системе, новая — в режиме мониторинга | - Обучить администраторов и врачей<br>- Собрать фидбэк по UX<br>- Проверить производительность и безопасность                                                    | PM, HR, DPO                  | Месяц 2–4   | Риск: Сопротивление персонала<br>Мера: Поощрение за использование новой системы                   |
| 4. Постепенное переключение    | Перевод функциональности по модулям                              | - Перевести: запись пациентов → анализы → отчётность<br>- Отключить старые модули по одному<br>- Обновить интеграции (1C, лаборатория)                           | DevOps, Интегратор           | Месяц 4–7   | Риск: Ошибки в интеграциях<br>Мера: Canary-релиз + мониторинг ошибок                              |
| 5. Отключение старой системы   | Финальная валидация и отключение legacy                          | - Провести финальный diff<br>- Заблокировать доступ к старой системе<br>- Перевести все нагрузки на новую                                                        | DevOps, Руководитель проекта | Месяц 7     | Риск: Остались "живые" ссылки на старую систему<br>Мера: Редирект 301 + уведомление пользователей |
| 6. Поддержка и оптимизация     | Мониторинг, обучение, обратная связь                             | - Собрать KPI<br>- Провести опросы<br>- Устранить баги и узкие места                                                                                             | PM, DevOps, HR               | Месяц 7–12  | Риск: Снижение производительности<br>Мера: Профилирование + оптимизация SQL, кэширование          |

---

## Контекст: ключевые направления трансформации

Этот cutover-план реализует следующие **приоритетные меры**, выявленные ранее:

### Высокий приоритет
- Внедрение шифрования (Vault)
- Настройка бэкапов и восстановления
- Запуск аудита действий с данными
- Внедрение DLP-системы
- Утверждение политики удаления ПДн

### Средний приоритет
- Переход на Kubernetes
- Замена Excel на PostgreSQL
- Настройка CI/CD
- Введение классификации данных

### Низкий приоритет
- Автоматизация записи пациентов
- Обучение персонала
- Сбор обратной связи

> Все эти меры **встраиваются в cutover-план** на соответствующих этапах.

---

## Управление рисками производительности

| Мера                             | Риск производительности           | Мера по снижению                                   |
| -------------------------------- | --------------------------------- | -------------------------------------------------- |
| Шифрование at rest (Vault + SSE) | +15–30% latency при чтении файлов | Кэширование в Redis; шифрование только метаданных  |
| DLP-сканирование email           | Задержка доставки на 1–5 сек      | Асинхронная обработка; исключение внутренних писем |
| Аудит всех действий              | Рост нагрузки на БД на 20–40%     | Асинхронная запись в ClickHouse через Kafka        |
| API Gateway + фильтрация PII     | Доп. задержка 5–10 мс             | Кэширование ответов; edge-размещение               |
| CI/CD + security-сканы           | Удлинение pipeline на 3–10 мин    | Incremental scan; кэширование зависимостей         |

---

## Обратная совместимость и миграция

- **Двойная запись (dual-write)** — включается на этапе 2, остаётся до отключения legacy.
- **Feature toggles** — управляют включением шифрования, DLP, аудита.
- **Blue/Green деплой** — используется для ключевых сервисов (Keycloak, BFF).
- **Мониторинг**: Prometheus + Grafana — метрики: latency, error rate, throughput.

---

## Контроль выполнения: KPI

| Показатель                            | Цель     | Измерение            |
| ------------------------------------- | -------- | -------------------- |
| Время восстановления после сбоя (RTO) | < 15 мин | Тест бэкапов         |
| Количество утечек данных              | 0        | DLP-логи, аудит      |
| Среднее время записи пациента         | < 2 мин  | Анализ логов портала |
| Доля успешных деплоев                 | > 95%    | CI/CD-логи           |
| Удовлетворённость персонала           | > 80%    | Опросы               |

---

## Дорожная карта (Timeline)

```mermaid
gantt
    title Cutover-план миграции "МЕДИКАМЕНТЕ"
    dateFormat  YYYY-MM-DD
    section Cutover
    Подготовка окружения     :c1, 2026-04-01, 30d
    Двойная запись           :c2, after c1, 30d
    Параллельная работа      :c3, after c2, 60d
    Переключение модулей     :c4, after c3, 90d
    Отключение legacy        :c5, after c4, 7d
    Поддержка и оптимизация  :c6, after c5, 150d
